#!/bin/sh
set -e

#--------------------------------------------------------------------------------------------------
# Settings
#--------------------------------------------------------------------------------------------------

VLC_version="3.0.6"

#--------------------------------------------------------------------------------------------------
# Syntax
#--------------------------------------------------------------------------------------------------

if [ $# != 1 ] \
   || \
   [ $1 != "win32" -a $1 != "win64" -a $1 != "macOS" -a $1 != "linux" -a $1 != "android32" -a \
                                                                         $1 != "android64" ]; then

    echo "Usage: build <win32 | win64 | macOS | linux | android32 | android64>"

    exit 1
fi

#--------------------------------------------------------------------------------------------------
# Configuration
#--------------------------------------------------------------------------------------------------

if [ $1 = "win32" -o $1 = "win64" ]; then

    os="windows"
else
    os="default"
fi

VLC="https://download.videolan.org/pub/videolan/vlc/$VLC_version/vlc-$VLC_version.tar.xz"

#--------------------------------------------------------------------------------------------------
# Clean
#--------------------------------------------------------------------------------------------------

echo "CLEANING"

rm -rf deploy
mkdir  deploy
touch  deploy/.gitignore

#--------------------------------------------------------------------------------------------------
# Install
#--------------------------------------------------------------------------------------------------

if [ $1 = "linux" ]; then

    sudo apt-get -y install build-essential curl pkg-config libtool automake autopoint gettext
fi

#--------------------------------------------------------------------------------------------------
# Download
#--------------------------------------------------------------------------------------------------

echo ""
echo "DOWNLOADING VLC"
echo $VLC

curl -L -o VLC.tar.xz $VLC

#--------------------------------------------------------------------------------------------------
# Extract
#--------------------------------------------------------------------------------------------------

echo ""
echo "EXTRACTING VLC"

# NOTE Windows: We need to use 7z otherwise it seems to freeze Azure.
if [ $os = "windows" ]; then

    7z x VLC.tar.xz
    7z x VLC.tar
else
    tar -xf VLC.tar.xz
fi

#--------------------------------------------------------------------------------------------------
# Dependencies
#--------------------------------------------------------------------------------------------------

echo ""
echo "GET DEPENDENCIES"

sudo apt-get -y build-dep vlc

#--------------------------------------------------------------------------------------------------
# Configure
#--------------------------------------------------------------------------------------------------

echo ""
echo "CONFIGURING VLC"

cd vlc-$VLC_version

./configure --prefix=$PWD/../deploy

#--------------------------------------------------------------------------------------------------
# Build
#--------------------------------------------------------------------------------------------------

echo ""
echo "BUILDING VLC"

if [ $os = "windows" ]; then

    mingw32-make
    mingw32-make install
else
    make
    make install
fi
